<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Family Tree</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0b07;
    --surface: #1a1510;
    --surface2: #241e16;
    --border: #3a3020;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dark: #8a6f2e;
    --text: #f0e8d5;
    --text-muted: #8a7d68;
    --red: #c94c4c;
    --green: #4c9a6a;
    --male: #3a6ea8;
    --female: #a83a6e;
    --radius: 12px;
    --shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* ‚îÄ‚îÄ NOISE TEXTURE ‚îÄ‚îÄ */
  body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    opacity: 0.4;
  }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  #auth-screen {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    background: radial-gradient(ellipse at center, #1a1510 0%, #0e0b07 70%);
  }
  .auth-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 48px 40px; width: 100%; max-width: 420px;
    box-shadow: 0 0 80px rgba(201,168,76,0.08), var(--shadow);
    position: relative; overflow: hidden;
  }
  .auth-box::before {
    content: ''; position: absolute; top: -2px; left: 20%; right: 20%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }
  .auth-logo { text-align: center; margin-bottom: 36px; }
  .auth-logo .tree-icon { font-size: 48px; display: block; margin-bottom: 12px; }
  .auth-logo h1 { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--gold-light); letter-spacing: 2px; }
  .auth-logo p { color: var(--text-muted); font-size: 13px; margin-top: 6px; letter-spacing: 1px; }
  
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; font-size: 12px; letter-spacing: 1.5px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
  .form-group input {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 13px 16px; color: var(--text); font-size: 15px; font-family: 'Lato', sans-serif;
    transition: border-color 0.2s, box-shadow 0.2s; outline: none;
  }
  .form-group input:focus { border-color: var(--gold-dark); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
  
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 13px 24px; border-radius: 8px; font-family: 'Lato', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 1px; cursor: pointer;
    border: none; transition: all 0.2s; text-transform: uppercase;
  }
  .btn-gold { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); color: #0e0b07; width: 100%; margin-top: 8px; }
  .btn-gold:hover { background: linear-gradient(135deg, var(--gold), var(--gold-light)); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(201,168,76,0.3); }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  .btn-outline:hover { border-color: var(--gold-dark); color: var(--gold); }
  .btn-danger { background: rgba(201,76,76,0.15); border: 1px solid rgba(201,76,76,0.3); color: var(--red); }
  .btn-danger:hover { background: rgba(201,76,76,0.25); }
  .btn-success { background: rgba(76,154,106,0.15); border: 1px solid rgba(76,154,106,0.3); color: var(--green); }
  .btn-success:hover { background: rgba(76,154,106,0.25); }
  
  .auth-toggle { text-align: center; margin-top: 20px; font-size: 13px; color: var(--text-muted); }
  .auth-toggle a { color: var(--gold); cursor: pointer; text-decoration: none; }
  .auth-toggle a:hover { color: var(--gold-light); }
  .auth-error { color: var(--red); font-size: 13px; margin-top: 10px; text-align: center; min-height: 20px; }

  /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
  #app { display: none; flex-direction: column; height: 100vh; position: relative; z-index: 1; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 50; flex-shrink: 0;
  }
  .header-brand { display: flex; align-items: center; gap: 10px; }
  .header-brand span { font-size: 22px; }
  .header-brand h2 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--gold-light); }
  .header-actions { display: flex; align-items: center; gap: 10px; }
  .user-pill { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 14px; font-size: 12px; color: var(--text-muted); }
  .icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; }
  .icon-btn:hover { border-color: var(--gold-dark); color: var(--gold); }

  /* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
  #toolbar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 10px 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    flex-shrink: 0;
  }
  #toolbar .btn { padding: 9px 16px; font-size: 12px; }
  .toolbar-sep { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }
  #search-box {
    flex: 1; min-width: 150px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 8px 14px; color: var(--text); font-size: 14px; font-family: 'Lato', sans-serif; outline: none;
  }
  #search-box:focus { border-color: var(--gold-dark); }
  #search-box::placeholder { color: var(--text-muted); }

  /* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
  #canvas-wrap { flex: 1; overflow: hidden; position: relative; cursor: grab; }
  #canvas-wrap.grabbing { cursor: grabbing; }
  #canvas {
    position: absolute; transform-origin: 0 0;
    /* will be set by JS */ 
  }

  /* ‚îÄ‚îÄ SVG CONNECTIONS ‚îÄ‚îÄ */
  #svg-layer { position: absolute; top: 0; left: 0; overflow: visible; pointer-events: none; }

  /* ‚îÄ‚îÄ PERSON CARD ‚îÄ‚îÄ */
  .person-card {
    position: absolute; width: 160px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px 12px 12px;
    cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    user-select: none; display: flex; flex-direction: column; align-items: center; gap: 8px;
  }
  .person-card:hover { border-color: var(--gold-dark); box-shadow: 0 0 24px rgba(201,168,76,0.15); transform: translateY(-2px); }
  .person-card.selected { border-color: var(--gold); box-shadow: 0 0 32px rgba(201,168,76,0.25); }
  .person-card.highlighted { border-color: var(--gold-light); box-shadow: 0 0 40px rgba(232,201,122,0.4); }
  
  .person-avatar {
    width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 24px; font-weight: 700; letter-spacing: -1px;
    border: 2px solid var(--border); flex-shrink: 0;
  }
  .person-avatar.male { background: rgba(58,110,168,0.2); border-color: rgba(58,110,168,0.5); color: #7aacdf; }
  .person-avatar.female { background: rgba(168,58,110,0.2); border-color: rgba(168,58,110,0.5); color: #df7aac; }
  .person-avatar.unknown { background: var(--surface2); border-color: var(--border); color: var(--text-muted); }
  
  .person-name { font-family: 'Playfair Display', serif; font-size: 13px; text-align: center; color: var(--text); line-height: 1.3; font-weight: 700; word-break: break-word; }
  .person-meta { font-size: 11px; color: var(--text-muted); text-align: center; }
  .person-badge { font-size: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 2px 7px; color: var(--text-muted); }

  /* ‚îÄ‚îÄ SIDE PANEL ‚îÄ‚îÄ */
  #side-panel {
    position: fixed; right: 0; top: 0; bottom: 0; width: 340px;
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 60; transform: translateX(100%); transition: transform 0.3s ease;
    display: flex; flex-direction: column; overflow: hidden;
  }
  #side-panel.open { transform: translateX(0); }
  .panel-header {
    padding: 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .panel-header h3 { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--gold-light); }
  .panel-body { padding: 20px; overflow-y: auto; flex: 1; }
  .panel-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; }
  .panel-footer .btn { flex: 1; }

  .field-group { margin-bottom: 18px; }
  .field-group label { display: block; font-size: 11px; letter-spacing: 1.5px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; }
  .field-group input, .field-group select, .field-group textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; color: var(--text); font-size: 14px; font-family: 'Lato', sans-serif;
    transition: border-color 0.2s; outline: none; resize: vertical;
  }
  .field-group input:focus, .field-group select:focus, .field-group textarea:focus { border-color: var(--gold-dark); }
  .field-group select option { background: var(--surface); }

  .section-title { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold-dark); margin-bottom: 12px; margin-top: 24px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }

  /* Relations chips */
  .chip-list { display: flex; flex-wrap: wrap; gap: 6px; }
  .chip { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 5px 12px; font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s; }
  .chip:hover { border-color: var(--gold-dark); color: var(--gold); }
  .chip .chip-x { color: var(--red); font-weight: 700; font-size: 14px; line-height: 1; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(14,11,7,0.85); z-index: 200;
    display: flex; align-items: center; justify-content: center; padding: 20px;
    backdrop-filter: blur(4px);
  }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; max-width: 400px; width: 100%; box-shadow: var(--shadow); }
  .modal h4 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--gold-light); margin-bottom: 12px; }
  .modal p { color: var(--text-muted); font-size: 14px; line-height: 1.6; margin-bottom: 24px; }
  .modal-actions { display: flex; gap: 10px; }
  .modal-actions .btn { flex: 1; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 20px; font-size: 14px; z-index: 999;
    transition: transform 0.3s ease; white-space: nowrap; box-shadow: var(--shadow);
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  #toast.success { border-color: var(--green); color: var(--green); }
  #toast.error { border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ MINI MAP ‚îÄ‚îÄ */
  #minimap {
    position: fixed; bottom: 20px; right: 20px; width: 160px; height: 100px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    overflow: hidden; cursor: pointer; z-index: 40;
  }
  #minimap canvas { width: 100%; height: 100%; }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  #empty-state {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 16px; pointer-events: none;
  }
  #empty-state .big-tree { font-size: 80px; opacity: 0.15; }
  #empty-state p { color: var(--text-muted); font-size: 15px; text-align: center; max-width: 280px; line-height: 1.6; }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  #loading {
    position: fixed; inset: 0; background: var(--bg); z-index: 999;
    display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px;
  }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 600px) {
    #side-panel { width: 100%; }
    .auth-box { padding: 32px 24px; }
    #toolbar { gap: 6px; padding: 8px 12px; }
    #toolbar .btn-text { display: none; }
    header { padding: 0 12px; }
    .user-pill { display: none; }
    #minimap { display: none; }
  }

  /* ‚îÄ‚îÄ ZOOM INDICATOR ‚îÄ‚îÄ */
  #zoom-indicator {
    position: fixed; bottom: 130px; right: 24px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px;
    font-size: 12px; color: var(--text-muted); z-index: 40; pointer-events: none;
  }

  /* RELATION SELECT MODAL */
  #relation-modal .rel-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
  .rel-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; cursor: pointer; text-align: center; transition: all 0.2s; color: var(--text); font-family: 'Lato', sans-serif; font-size: 13px; }
  .rel-btn:hover { border-color: var(--gold-dark); color: var(--gold); background: rgba(201,168,76,0.05); }
  .rel-btn .rel-icon { font-size: 22px; display: block; margin-bottom: 6px; }

  /* Photo avatar */
  .avatar-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold-dark); }
  .photo-upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s; color: var(--text-muted); font-size: 13px; }
  .photo-upload-area:hover { border-color: var(--gold-dark); color: var(--gold); }
  
  /* Connection line labels */
  .conn-label { font-size: 10px; fill: var(--text-muted); }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <p style="color:var(--text-muted);font-size:14px;">Connecting‚Ä¶</p>
</div>

<!-- AUTH -->
<div id="auth-screen" style="display:none">
  <div class="auth-box">
    <div class="auth-logo">
      <span class="tree-icon">üå≥</span>
      <h1>Family Tree</h1>
      <p>PRESERVE YOUR LEGACY</p>
    </div>
    <div id="auth-login">
      <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="auth-error" id="login-error"></div>
      <button class="btn btn-gold" onclick="doLogin()">üîê Sign In</button>
      <div class="auth-toggle">Don't have an account? <a onclick="showRegister()">Create one</a></div>
    </div>
    <div id="auth-register" style="display:none">
      <div class="form-group"><label>Full Name</label><input type="text" id="reg-name" placeholder="Your name"></div>
      <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="your@email.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-pass" placeholder="Min 6 characters"></div>
      <div class="form-group"><label>Confirm Password</label><input type="password" id="reg-pass2" placeholder="Repeat password"></div>
      <div class="auth-error" id="reg-error"></div>
      <button class="btn btn-gold" onclick="doRegister()">üå± Create Account</button>
      <div class="auth-toggle">Already have an account? <a onclick="showLogin()">Sign in</a></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <header>
    <div class="header-brand">
      <span>üå≥</span>
      <h2>Family Tree</h2>
    </div>
    <div class="header-actions">
      <span class="user-pill" id="user-label">‚Äî</span>
      <button class="icon-btn" onclick="toggleSearch()" title="Search">üîç</button>
      <button class="icon-btn" onclick="fitView()" title="Fit to screen">‚äû</button>
      <button class="icon-btn" onclick="doLogout()" title="Sign out">‚èè</button>
    </div>
  </header>

  <div id="toolbar">
    <button class="btn btn-gold" onclick="openAddPerson(null)">Ôºã <span class="btn-text">Add Person</span></button>
    <div class="toolbar-sep"></div>
    <button class="btn btn-outline" onclick="zoomIn()" title="Zoom in">Ôºã</button>
    <button class="btn btn-outline" onclick="zoomOut()" title="Zoom out">Ôºç</button>
    <button class="btn btn-outline" onclick="fitView()" title="Reset view">‚ä°</button>
    <div class="toolbar-sep"></div>
    <input type="text" id="search-box" placeholder="üîç Search name‚Ä¶" oninput="doSearch(this.value)" style="display:none">
    <span style="flex:1"></span>
    <button class="btn btn-outline" onclick="exportData()" title="Export">‚¨á <span class="btn-text">Export</span></button>
  </div>

  <div id="canvas-wrap">
    <div id="empty-state">
      <div class="big-tree">üå≥</div>
      <p>Your family tree is empty.<br>Tap <strong>+ Add Person</strong> to begin your legacy.</p>
    </div>
    <div id="canvas">
      <svg id="svg-layer"></svg>
    </div>
  </div>

  <div id="zoom-indicator">100%</div>
</div>

<!-- SIDE PANEL (Add/Edit Person) -->
<div id="side-panel">
  <div class="panel-header">
    <h3 id="panel-title">Add Person</h3>
    <button class="icon-btn" onclick="closePanel()">‚úï</button>
  </div>
  <div class="panel-body">
    <input type="hidden" id="edit-id">

    <!-- Photo -->
    <div class="field-group" style="text-align:center">
      <div id="photo-preview" style="margin-bottom:10px"></div>
      <div class="photo-upload-area" onclick="document.getElementById('photo-file').click()">üì∑ Tap to add photo</div>
      <input type="file" id="photo-file" accept="image/*" style="display:none" onchange="handlePhoto(this)">
      <input type="hidden" id="edit-photo">
    </div>

    <div class="field-group">
      <label>First Name *</label>
      <input type="text" id="edit-first" placeholder="First name">
    </div>
    <div class="field-group">
      <label>Last Name</label>
      <input type="text" id="edit-last" placeholder="Last name">
    </div>
    <div class="field-group">
      <label>Gender</label>
      <select id="edit-gender">
        <option value="unknown">Prefer not to say</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </div>
    <div class="field-group">
      <label>Date of Birth</label>
      <input type="date" id="edit-dob">
    </div>
    <div class="field-group">
      <label>Date of Death</label>
      <input type="date" id="edit-dod">
    </div>
    <div class="field-group">
      <label>Birthplace</label>
      <input type="text" id="edit-place" placeholder="City, Country">
    </div>
    <div class="field-group">
      <label>Notes / Bio</label>
      <textarea id="edit-notes" rows="3" placeholder="Brief biography‚Ä¶"></textarea>
    </div>

    <div id="relations-section" style="display:none">
      <div class="section-title">Relations</div>
      <div id="relations-list" class="chip-list"></div>
      <button class="btn btn-outline" style="margin-top:10px;width:100%;font-size:12px" onclick="openRelationPicker()">Ôºã Add Relation</button>
    </div>
  </div>
  <div class="panel-footer">
    <button class="btn btn-success" onclick="savePerson()">üíæ Save</button>
    <button id="btn-delete-person" class="btn btn-danger" onclick="confirmDelete()" style="display:none">üóë Delete</button>
    <button class="btn btn-outline" onclick="closePanel()">Cancel</button>
  </div>
</div>

<!-- RELATION MODAL -->
<div id="relation-modal" class="modal-overlay" style="display:none">
  <div class="modal">
    <h4>Add Relation</h4>
    <p style="margin-bottom:0">Choose the relationship type for <strong id="rel-person-name" style="color:var(--gold)"></strong>:</p>
    <div class="rel-options">
      <button class="rel-btn" onclick="addRelation('parent')"><span class="rel-icon">üë¥</span>Parent of me</button>
      <button class="rel-btn" onclick="addRelation('child')"><span class="rel-icon">üë∂</span>Child of me</button>
      <button class="rel-btn" onclick="addRelation('spouse')"><span class="rel-icon">üíç</span>Spouse / Partner</button>
      <button class="rel-btn" onclick="addRelation('sibling')"><span class="rel-icon">ü§ù</span>Sibling</button>
    </div>
    <div style="margin-top:16px;text-align:right">
      <button class="btn btn-outline" onclick="closeRelationModal()" style="padding:9px 20px">Cancel</button>
    </div>
  </div>
</div>

<!-- PERSON SELECT MODAL (picking a relation target) -->
<div id="person-select-modal" class="modal-overlay" style="display:none">
  <div class="modal" style="max-width:480px">
    <h4>Select Person</h4>
    <input type="text" id="person-filter" placeholder="Type to filter‚Ä¶" oninput="filterPersonList(this.value)"
      style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Lato',sans-serif;font-size:14px;outline:none;margin-bottom:14px">
    <div id="person-list" style="max-height:300px;overflow-y:auto;display:flex;flex-direction:column;gap:6px"></div>
    <div style="margin-top:16px;text-align:right">
      <button class="btn btn-outline" onclick="closePersonSelect()" style="padding:9px 20px">Cancel</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div id="confirm-modal" class="modal-overlay" style="display:none">
  <div class="modal">
    <h4>Delete Person?</h4>
    <p>This will permanently remove this person and all their connections from the family tree. This action cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deletePerson()">üóë Delete</button>
      <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üîß FIREBASE CONFIG ‚Äî Replace with YOUR config
//  1. Go to https://console.firebase.google.com
//  2. Create a project ‚Üí Add Web App
//  3. Enable Authentication (Email/Password)
//  4. Enable Firestore Database
//  5. Replace the values below
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCuSuydApfXzvWQNXrg7wAjo13SwxxNn9w",
  authDomain: "my-family-tree-41cbe.firebaseapp.com",
  projectId: "my-family-tree-41cbe",
  storageBucket: "my-family-tree-41cbe.firebasestorage.app",
  messagingSenderId: "915926313263",
  appId: "1:915926313263:web:7d55bb49c19e15b2a219da",
  measurementId: "G-49E2BPLGMH"
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db   = firebase.firestore();

let currentUser = null;
let treeRef = null;
let unsubscribe = null;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let persons = {};      // { id: personData }
let relations = {};    // { id: {from, to, type} }
let selectedId = null;
let panX = 60, panY = 60, zoom = 1;
let isPanning = false, panStart = {x:0, y:0};

// ‚îÄ‚îÄ AUTH FLOW ‚îÄ‚îÄ
auth.onAuthStateChanged(user => {
  document.getElementById('loading').style.display = 'none';
  if (user) {
    currentUser = user;
    treeRef = db.collection('trees').doc(user.uid);
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('user-label').textContent = user.email.split('@')[0];
    listenToTree();
  } else {
    currentUser = null;
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
  }
});

function showRegister() { document.getElementById('auth-login').style.display='none'; document.getElementById('auth-register').style.display='block'; }
function showLogin()    { document.getElementById('auth-register').style.display='none'; document.getElementById('auth-login').style.display='block'; }

async function doLogin() {
  const e = document.getElementById('login-email').value.trim();
  const p = document.getElementById('login-pass').value;
  document.getElementById('login-error').textContent = '';
  try { await auth.signInWithEmailAndPassword(e, p); }
  catch(err) { document.getElementById('login-error').textContent = friendlyError(err.code); }
}

async function doRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const e    = document.getElementById('reg-email').value.trim();
  const p    = document.getElementById('reg-pass').value;
  const p2   = document.getElementById('reg-pass2').value;
  document.getElementById('reg-error').textContent = '';
  if (!name) { document.getElementById('reg-error').textContent = 'Please enter your name.'; return; }
  if (p !== p2) { document.getElementById('reg-error').textContent = 'Passwords do not match.'; return; }
  try {
    const cred = await auth.createUserWithEmailAndPassword(e, p);
    await cred.user.updateProfile({ displayName: name });
  } catch(err) { document.getElementById('reg-error').textContent = friendlyError(err.code); }
}

async function doLogout() {
  await auth.signOut();
  persons = {}; relations = {}; selectedId = null;
}

function friendlyError(code) {
  const m = { 'auth/user-not-found':'No account with that email.', 'auth/wrong-password':'Incorrect password.', 'auth/email-already-in-use':'Email already registered.', 'auth/weak-password':'Password must be at least 6 characters.', 'auth/invalid-email':'Invalid email address.' };
  return m[code] || code;
}

// ‚îÄ‚îÄ FIRESTORE LISTENER ‚îÄ‚îÄ
function listenToTree() {
  if (unsubscribe) unsubscribe();
  unsubscribe = treeRef.onSnapshot(doc => {
    const data = doc.exists ? doc.data() : { persons: {}, relations: {} };
    persons   = data.persons   || {};
    relations = data.relations || {};
    renderTree();
  }, err => { if(err.code !== 'permission-denied') showToast('Connection error', 'error'); });
}

async function saveTree() {
  if (!currentUser) return;
  try {
    await treeRef.set({ persons, relations });
  } catch(e) { showToast('Save failed: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ ID GENERATION ‚îÄ‚îÄ
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }

// ‚îÄ‚îÄ CANVAS / VIEWPORT ‚îÄ‚îÄ
const canvasWrap = document.getElementById('canvas-wrap');
const canvas     = document.getElementById('canvas');
const svgLayer   = document.getElementById('svg-layer');

function applyTransform() {
  canvas.style.transform = `translate(${panX}px,${panY}px) scale(${zoom})`;
  document.getElementById('zoom-indicator').textContent = Math.round(zoom*100)+'%';
}

function zoomIn()  { zoom = Math.min(zoom * 1.2, 4);   applyTransform(); }
function zoomOut() { zoom = Math.max(zoom / 1.2, 0.15); applyTransform(); }

function fitView() {
  const cards = document.querySelectorAll('.person-card');
  if (!cards.length) { panX=60; panY=60; zoom=1; applyTransform(); return; }
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  cards.forEach(c => {
    const l = parseInt(c.style.left), t = parseInt(c.style.top);
    minX=Math.min(minX,l); minY=Math.min(minY,t);
    maxX=Math.max(maxX,l+160); maxY=Math.max(maxY,t+120);
  });
  const W = canvasWrap.clientWidth, H = canvasWrap.clientHeight;
  const tw = maxX-minX+80, th = maxY-minY+80;
  zoom = Math.min(W/tw, H/th, 1.5);
  panX = (W - tw*zoom)/2 - minX*zoom + 40*zoom;
  panY = (H - th*zoom)/2 - minY*zoom + 40*zoom;
  applyTransform();
}

// Pan via mouse/touch
let lastTouch = null;
canvasWrap.addEventListener('mousedown', e => { if(e.target===canvasWrap||e.target===canvas||e.target===svgLayer) { isPanning=true; panStart={x:e.clientX-panX, y:e.clientY-panY}; canvasWrap.classList.add('grabbing'); } });
document.addEventListener('mousemove', e => { if(isPanning){ panX=e.clientX-panStart.x; panY=e.clientY-panStart.y; applyTransform(); } });
document.addEventListener('mouseup', () => { isPanning=false; canvasWrap.classList.remove('grabbing'); });

canvasWrap.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? 0.9 : 1.1;
  const rect = canvasWrap.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const newZoom = Math.max(0.15, Math.min(4, zoom * delta));
  panX = mx - (mx - panX) * (newZoom/zoom);
  panY = my - (my - panY) * (newZoom/zoom);
  zoom = newZoom; applyTransform();
}, {passive:false});

// Touch pan/pinch
canvasWrap.addEventListener('touchstart', e => {
  if(e.touches.length===1) { isPanning=true; lastTouch=e.touches[0]; panStart={x:e.touches[0].clientX-panX, y:e.touches[0].clientY-panY}; }
  if(e.touches.length===2) { isPanning=false; lastTouch=e.touches; }
}, {passive:true});
canvasWrap.addEventListener('touchmove', e => {
  if(e.touches.length===1 && isPanning) { panX=e.touches[0].clientX-panStart.x; panY=e.touches[0].clientY-panStart.y; applyTransform(); }
  if(e.touches.length===2 && lastTouch && lastTouch.length===2) {
    const d1 = Math.hypot(lastTouch[0].clientX-lastTouch[1].clientX, lastTouch[0].clientY-lastTouch[1].clientY);
    const d2 = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    const mid = { x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2 };
    const rect = canvasWrap.getBoundingClientRect();
    const mx=mid.x-rect.left, my=mid.y-rect.top;
    const newZoom = Math.max(0.15, Math.min(4, zoom*(d2/d1)));
    panX = mx - (mx-panX)*(newZoom/zoom); panY = my - (my-panY)*(newZoom/zoom);
    zoom = newZoom; applyTransform(); lastTouch = e.touches;
  }
}, {passive:true});
canvasWrap.addEventListener('touchend', () => { isPanning=false; lastTouch=null; });

// ‚îÄ‚îÄ LAYOUT ENGINE ‚îÄ‚îÄ
// Auto-position: generational layout
function computeLayout() {
  const pos = {};
  if (!Object.keys(persons).length) return pos;

  // Find roots: people with no parents
  function getParents(id) {
    return Object.values(relations).filter(r => r.type==='parent-child' && r.child===id).map(r=>r.parent);
  }
  function getChildren(id) {
    return Object.values(relations).filter(r => r.type==='parent-child' && r.parent===id).map(r=>r.child);
  }
  function getSpouses(id) {
    return Object.values(relations).filter(r => r.type==='spouse' && (r.from===id||r.to===id)).map(r=>r.from===id?r.to:r.from);
  }

  const allIds = Object.keys(persons);
  const rootIds = allIds.filter(id => getParents(id).length === 0);

  const CARD_W = 180, CARD_H = 140, GAP_X = 40, GAP_Y = 80;
  const placed = new Set();
  const genMap = {}; // id -> gen

  function assignGen(id, gen) {
    if (genMap[id] !== undefined) return;
    genMap[id] = gen;
    getChildren(id).forEach(c => assignGen(c, gen+1));
    getSpouses(id).forEach(s => { if(genMap[s]===undefined) genMap[s]=gen; });
  }

  rootIds.forEach(r => assignGen(r, 0));
  allIds.forEach(id => { if(genMap[id]===undefined) genMap[id]=0; });

  // Group by generation
  const gens = {};
  allIds.forEach(id => { const g=genMap[id]; (gens[g]=gens[g]||[]).push(id); });

  Object.keys(gens).sort((a,b)=>+a-+b).forEach(g => {
    const ids = gens[g];
    ids.forEach((id, i) => {
      pos[id] = { x: i*(CARD_W+GAP_X), y: +g*(CARD_H+GAP_Y) };
    });
  });

  // Keep stored positions if they exist
  allIds.forEach(id => {
    if (persons[id].x !== undefined && persons[id].y !== undefined) {
      pos[id] = { x: persons[id].x, y: persons[id].y };
    }
  });

  return pos;
}

// ‚îÄ‚îÄ RENDER TREE ‚îÄ‚îÄ
function renderTree() {
  const ids = Object.keys(persons);
  document.getElementById('empty-state').style.display = ids.length ? 'none' : 'flex';

  // Remove old cards
  document.querySelectorAll('.person-card').forEach(c=>c.remove());
  svgLayer.innerHTML = '';

  if (!ids.length) return;

  const pos = computeLayout();

  // Determine canvas size for SVG
  const maxX = Math.max(...Object.values(pos).map(p=>p.x)) + 200;
  const maxY = Math.max(...Object.values(pos).map(p=>p.y)) + 160;
  svgLayer.setAttribute('width', maxX+200);
  svgLayer.setAttribute('height', maxY+200);
  svgLayer.style.width  = (maxX+200)+'px';
  svgLayer.style.height = (maxY+200)+'px';

  // Draw relations first (under cards)
  Object.values(relations).forEach(rel => {
    const fromP = pos[rel.from || rel.parent];
    const toP   = pos[rel.to   || rel.child];
    if (!fromP || !toP) return;
    drawConnection(rel, fromP, toP);
  });

  // Draw person cards
  ids.forEach(id => {
    const p = persons[id];
    const xy = pos[id] || {x:60,y:60};
    createCard(id, p, xy.x, xy.y);
  });

  // Update side panel if someone selected
  if (selectedId && persons[selectedId]) {
    updateRelationsList(selectedId);
  }
}

function createCard(id, p, x, y) {
  const card = document.createElement('div');
  card.className = 'person-card' + (id===selectedId?' selected':'');
  card.id = 'card-'+id;
  card.style.left = x+'px';
  card.style.top  = y+'px';

  const initials = ((p.firstName||'?')[0]+(p.lastName||'')[0]).toUpperCase();
  const genderClass = p.gender || 'unknown';

  let avatarHtml = p.photo
    ? `<img src="${p.photo}" class="avatar-img" alt="photo">`
    : `<div class="person-avatar ${genderClass}">${initials}</div>`;

  const dob = p.dob ? new Date(p.dob).getFullYear() : '';
  const dod = p.dod ? new Date(p.dod).getFullYear() : '';
  const lifespan = dob ? (dod ? `${dob} ‚Äì ${dod}` : `b. ${dob}`) : '';

  card.innerHTML = `
    ${avatarHtml}
    <div class="person-name">${p.firstName||''} ${p.lastName||''}</div>
    ${lifespan ? `<div class="person-meta">${lifespan}</div>` : ''}
    ${p.place ? `<div class="person-badge">üìç ${p.place}</div>` : ''}
  `;

  card.addEventListener('click', e => { e.stopPropagation(); selectPerson(id); });

  // Drag to reposition
  makeDraggable(card, id);
  canvas.appendChild(card);
}

function makeDraggable(card, id) {
  let dragging=false, ox=0, oy=0, moved=false;
  function startDrag(cx,cy) { dragging=true; moved=false; const rect=card.getBoundingClientRect(); const wrap=canvasWrap.getBoundingClientRect(); ox=(cx-wrap.left-panX)/zoom-parseInt(card.style.left); oy=(cy-wrap.top-panY)/zoom-parseInt(card.style.top); }
  function moveDrag(cx,cy) { if(!dragging)return; moved=true; const wrap=canvasWrap.getBoundingClientRect(); card.style.left=Math.max(0,(cx-wrap.left-panX)/zoom-ox)+'px'; card.style.top=Math.max(0,(cy-wrap.top-panY)/zoom-oy)+'px'; redrawConnections(); }
  function endDrag() { if(!dragging)return; dragging=false; if(moved){ const x=parseInt(card.style.left), y=parseInt(card.style.top); persons[id].x=x; persons[id].y=y; saveTree(); } }
  card.addEventListener('mousedown',e=>{if(e.button===0&&!e.ctrlKey){e.stopPropagation();startDrag(e.clientX,e.clientY);}});
  document.addEventListener('mousemove',e=>{if(dragging)moveDrag(e.clientX,e.clientY);});
  document.addEventListener('mouseup',endDrag);
  card.addEventListener('touchstart',e=>{e.stopPropagation();startDrag(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  card.addEventListener('touchmove',e=>{moveDrag(e.touches[0].clientX,e.touches[0].clientY);},{passive:true});
  card.addEventListener('touchend',endDrag);
}

function drawConnection(rel, fromP, toP) {
  const CARD_W=160, CARD_H_HALF=70;
  const x1=fromP.x+CARD_W/2, y1=fromP.y+CARD_H_HALF;
  const x2=toP.x+CARD_W/2,   y2=toP.y+CARD_H_HALF;
  const mx=(x1+x2)/2, my=(y1+y2)/2;

  const path = document.createElementNS('http://www.w3.org/2000/svg','path');
  let color='#3a3020', dashed=false;
  if(rel.type==='parent-child'){ color='#4c6e4a'; }
  else if(rel.type==='spouse') { color='#8a5a4a'; dashed=true; }
  else if(rel.type==='sibling'){ color='#4a5a8a'; }

  const cy1=y1+(y2-y1)*0.4, cy2=y2-(y2-y1)*0.4;
  path.setAttribute('d', `M${x1},${y1} C${x1},${cy1} ${x2},${cy2} ${x2},${y2}`);
  path.setAttribute('stroke', color);
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  path.setAttribute('opacity', '0.7');
  if(dashed) path.setAttribute('stroke-dasharray','6,4');
  svgLayer.appendChild(path);

  // Label
  const labels = {'parent-child':'üë∂','spouse':'üíç','sibling':'ü§ù'};
  const text = document.createElementNS('http://www.w3.org/2000/svg','text');
  text.setAttribute('x', mx); text.setAttribute('y', my-6);
  text.setAttribute('text-anchor','middle'); text.setAttribute('class','conn-label');
  text.setAttribute('font-size','12'); text.setAttribute('fill', '#6a5d48');
  text.textContent = labels[rel.type]||'';
  svgLayer.appendChild(text);
}

function redrawConnections() {
  svgLayer.innerHTML = '';
  const cards = document.querySelectorAll('.person-card');
  const pos = {};
  cards.forEach(c => {
    const id = c.id.replace('card-','');
    pos[id] = { x: parseInt(c.style.left), y: parseInt(c.style.top) };
  });
  Object.values(relations).forEach(rel => {
    const fp = pos[rel.from||rel.parent], tp = pos[rel.to||rel.child];
    if(fp&&tp) drawConnection(rel, fp, tp);
  });
}

// ‚îÄ‚îÄ SELECT PERSON ‚îÄ‚îÄ
function selectPerson(id) {
  selectedId = id;
  document.querySelectorAll('.person-card').forEach(c => c.classList.toggle('selected', c.id==='card-'+id));
  openEditPerson(id);
}

canvasWrap.addEventListener('click', e => {
  if (e.target===canvasWrap||e.target===canvas||e.target===svgLayer) {
    selectedId=null;
    document.querySelectorAll('.person-card').forEach(c=>c.classList.remove('selected'));
    closePanel();
  }
});

// ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ
function openAddPerson(parentId) {
  clearPanel();
  document.getElementById('panel-title').textContent = 'Add Person';
  document.getElementById('btn-delete-person').style.display = 'none';
  document.getElementById('relations-section').style.display = 'none';
  document.getElementById('side-panel').classList.add('open');
}

function openEditPerson(id) {
  const p = persons[id];
  if (!p) return;
  document.getElementById('panel-title').textContent = 'Edit Person';
  document.getElementById('btn-delete-person').style.display = '';
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-first').value = p.firstName||'';
  document.getElementById('edit-last').value  = p.lastName||'';
  document.getElementById('edit-gender').value= p.gender||'unknown';
  document.getElementById('edit-dob').value   = p.dob||'';
  document.getElementById('edit-dod').value   = p.dod||'';
  document.getElementById('edit-place').value = p.place||'';
  document.getElementById('edit-notes').value = p.notes||'';
  document.getElementById('edit-photo').value = p.photo||'';
  updatePhotoPreview(p.photo);
  document.getElementById('relations-section').style.display = '';
  updateRelationsList(id);
  document.getElementById('side-panel').classList.add('open');
}

function clearPanel() {
  ['edit-id','edit-first','edit-last','edit-dob','edit-dod','edit-place','edit-notes','edit-photo'].forEach(f=>document.getElementById(f).value='');
  document.getElementById('edit-gender').value='unknown';
  document.getElementById('photo-preview').innerHTML='';
}

function closePanel() {
  document.getElementById('side-panel').classList.remove('open');
}

// ‚îÄ‚îÄ SAVE PERSON ‚îÄ‚îÄ
async function savePerson() {
  const first = document.getElementById('edit-first').value.trim();
  if (!first) { showToast('First name is required', 'error'); return; }
  const id = document.getElementById('edit-id').value || uid();
  
  // Keep existing position if editing
  const existing = persons[id] || {};
  persons[id] = {
    firstName: first,
    lastName:  document.getElementById('edit-last').value.trim(),
    gender:    document.getElementById('edit-gender').value,
    dob:       document.getElementById('edit-dob').value,
    dod:       document.getElementById('edit-dod').value,
    place:     document.getElementById('edit-place').value.trim(),
    notes:     document.getElementById('edit-notes').value.trim(),
    photo:     document.getElementById('edit-photo').value,
    x:         existing.x,
    y:         existing.y,
    createdAt: existing.createdAt || Date.now(),
    updatedAt: Date.now()
  };

  await saveTree();
  showToast('Saved!', 'success');
  selectedId = id;
  // panel stays open for relations
  document.getElementById('edit-id').value = id;
  document.getElementById('panel-title').textContent = 'Edit Person';
  document.getElementById('btn-delete-person').style.display = '';
  document.getElementById('relations-section').style.display = '';
  updateRelationsList(id);
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
function confirmDelete() { document.getElementById('confirm-modal').style.display='flex'; }
function closeConfirm()  { document.getElementById('confirm-modal').style.display='none'; }

async function deletePerson() {
  const id = document.getElementById('edit-id').value;
  if (!id || !persons[id]) return;
  delete persons[id];
  // Remove all relations involving this person
  Object.keys(relations).forEach(k => {
    const r = relations[k];
    if(r.from===id||r.to===id||r.parent===id||r.child===id) delete relations[k];
  });
  await saveTree();
  closeConfirm(); closePanel(); selectedId=null;
  showToast('Person deleted', 'success');
}

// ‚îÄ‚îÄ RELATIONS ‚îÄ‚îÄ
function updateRelationsList(personId) {
  const list = document.getElementById('relations-list');
  list.innerHTML = '';
  const myRels = Object.entries(relations).filter(([k,r])=>r.from===personId||r.to===personId||r.parent===personId||r.child===personId);
  if (!myRels.length) { list.innerHTML='<span style="color:var(--text-muted);font-size:13px">No relations yet.</span>'; return; }
  myRels.forEach(([k,r]) => {
    const otherId = (r.from===personId ? r.to : r.to===personId ? r.from : r.parent===personId ? r.child : r.parent);
    const other = persons[otherId];
    if (!other) return;
    const chip = document.createElement('div');
    chip.className = 'chip';
    const labels = {'parent-child': r.parent===personId?'Parent of':'Child of', 'spouse':'Spouse', 'sibling':'Sibling'};
    chip.innerHTML = `<span>${labels[r.type]||r.type} <strong>${other.firstName} ${other.lastName||''}</strong></span><span class="chip-x" onclick="removeRelation('${k}')">√ó</span>`;
    list.appendChild(chip);
  });
}

let pendingRelationType = null;
let pendingTargetId     = null;

function openRelationPicker() {
  const myId = document.getElementById('edit-id').value;
  if (!myId) { showToast('Save the person first', 'error'); return; }
  document.getElementById('rel-person-name').textContent = persons[myId]?.firstName || '';
  document.getElementById('relation-modal').style.display = 'flex';
}
function closeRelationModal() { document.getElementById('relation-modal').style.display='none'; }

function addRelation(type) {
  pendingRelationType = type;
  closeRelationModal();
  openPersonSelect();
}

function openPersonSelect() {
  const myId = document.getElementById('edit-id').value;
  const modal = document.getElementById('person-select-modal');
  modal.style.display = 'flex';
  renderPersonList(myId, '');
}
function closePersonSelect() { document.getElementById('person-select-modal').style.display='none'; }

function filterPersonList(q) {
  const myId = document.getElementById('edit-id').value;
  renderPersonList(myId, q);
}

function renderPersonList(myId, q) {
  const container = document.getElementById('person-list');
  container.innerHTML = '';
  Object.entries(persons).filter(([id,p])=>{
    if(id===myId) return false;
    const name = `${p.firstName} ${p.lastName||''}`.toLowerCase();
    return !q || name.includes(q.toLowerCase());
  }).forEach(([id,p])=>{
    const row = document.createElement('div');
    row.style.cssText='background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:border-color 0.2s';
    const initials = ((p.firstName||'?')[0]+(p.lastName||'')[0]).toUpperCase();
    row.innerHTML = `<div class="person-avatar ${p.gender||'unknown'}" style="width:36px;height:36px;font-size:14px">${initials}</div><span>${p.firstName} ${p.lastName||''}</span>`;
    row.addEventListener('mouseenter',()=>row.style.borderColor='var(--gold-dark)');
    row.addEventListener('mouseleave',()=>row.style.borderColor='var(--border)');
    row.addEventListener('click',()=>finishAddRelation(id));
    container.appendChild(row);
  });
  if(!container.children.length) container.innerHTML='<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px">No persons found.</p>';
}

async function finishAddRelation(targetId) {
  closePersonSelect();
  const myId = document.getElementById('edit-id').value;
  const type  = pendingRelationType;

  let relObj = {};
  const k = uid();
  if (type==='parent')  { relObj = {type:'parent-child', parent:targetId, child:myId, from:targetId, to:myId}; }
  if (type==='child')   { relObj = {type:'parent-child', parent:myId, child:targetId, from:myId, to:targetId}; }
  if (type==='spouse')  { relObj = {type:'spouse', from:myId, to:targetId}; }
  if (type==='sibling') { relObj = {type:'sibling', from:myId, to:targetId}; }

  // Deduplicate
  const dup = Object.values(relations).some(r=>
    (r.type===relObj.type) && (
      (r.from===relObj.from&&r.to===relObj.to)||(r.from===relObj.to&&r.to===relObj.from)||
      (r.parent===relObj.parent&&r.child===relObj.child)
    ));
  if(dup){ showToast('Relation already exists','error'); return; }

  relations[k] = relObj;
  await saveTree();
  updateRelationsList(myId);
  showToast('Relation added!', 'success');
}

async function removeRelation(k) {
  if(!relations[k]) return;
  delete relations[k];
  await saveTree();
  const myId = document.getElementById('edit-id').value;
  updateRelationsList(myId);
  showToast('Relation removed', 'success');
}

// ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ
function handlePhoto(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    // Compress to max 200px
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 200;
      let w=img.width, h=img.height;
      if(w>h){ if(w>max){h*=max/w;w=max;} } else { if(h>max){w*=max/h;h=max;} }
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
      document.getElementById('edit-photo').value = dataUrl;
      updatePhotoPreview(dataUrl);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
function updatePhotoPreview(url) {
  const preview = document.getElementById('photo-preview');
  preview.innerHTML = url ? `<img src="${url}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--gold-dark)">` : '';
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
let searchVisible = false;
function toggleSearch() {
  const box = document.getElementById('search-box');
  searchVisible = !searchVisible;
  box.style.display = searchVisible ? '' : 'none';
  if(searchVisible) { box.focus(); doSearch(''); }
  else { doSearch(''); }
}
function doSearch(q) {
  document.querySelectorAll('.person-card').forEach(card => {
    const id = card.id.replace('card-','');
    const p = persons[id];
    if(!p) return;
    const name = `${p.firstName} ${p.lastName||''} ${p.place||''}`.toLowerCase();
    const match = !q || name.includes(q.toLowerCase());
    card.classList.toggle('highlighted', !!q && match);
    card.style.opacity = q && !match ? '0.3' : '1';
  });
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportData() {
  const data = JSON.stringify({ persons, relations, exportedAt: new Date().toISOString() }, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download='family-tree.json'; a.click();
  URL.revokeObjectURL(url);
  showToast('Exported!', 'success');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = type;
  void t.offsetWidth; // reflow
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2800);
}

// ‚îÄ‚îÄ INITIAL ‚îÄ‚îÄ
applyTransform();
</script>
</body>
</html>