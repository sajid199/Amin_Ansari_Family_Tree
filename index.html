<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Amin Ansari Family Tree</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0b07; --surface: #1a1510; --surface2: #241e16; --border: #3a3020;
    --gold: #c9a84c; --gold-light: #e8c97a; --gold-dark: #8a6f2e;
    --text: #f0e8d5; --text-muted: #8a7d68; --red: #c94c4c; --green: #4c9a6a;
    --radius: 12px; --shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  body::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:0; background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E"); opacity:0.4; }

  /* LOADING */
  #loading { position:fixed; inset:0; background:var(--bg); z-index:999; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px; }
  .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--gold); border-radius:50%; animation:spin 0.8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* ADMIN LOGIN MODAL */
  #admin-login-modal { position:fixed; inset:0; z-index:200; display:none; align-items:center; justify-content:center; background:rgba(14,11,7,0.92); backdrop-filter:blur(6px); }
  #admin-login-modal.open { display:flex; }
  .auth-box { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:40px 36px; width:100%; max-width:400px; box-shadow:0 0 80px rgba(201,168,76,0.1),var(--shadow); position:relative; overflow:hidden; }
  .auth-box::before { content:''; position:absolute; top:-2px; left:20%; right:20%; height:2px; background:linear-gradient(90deg,transparent,var(--gold),transparent); }
  .auth-logo { text-align:center; margin-bottom:28px; }
  .auth-logo .tree-icon { font-size:40px; display:block; margin-bottom:10px; }
  .auth-logo h1 { font-family:'Playfair Display',serif; font-size:22px; color:var(--gold-light); letter-spacing:2px; }
  .auth-logo p { color:var(--text-muted); font-size:12px; margin-top:4px; }
  .form-group { margin-bottom:18px; }
  .form-group label { display:block; font-size:11px; letter-spacing:1.5px; color:var(--text-muted); text-transform:uppercase; margin-bottom:6px; }
  .form-group input { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-size:14px; font-family:'Lato',sans-serif; transition:border-color 0.2s,box-shadow 0.2s; outline:none; }
  .form-group input:focus { border-color:var(--gold-dark); box-shadow:0 0 0 3px rgba(201,168,76,0.1); }
  .auth-error { color:var(--red); font-size:12px; margin-top:8px; text-align:center; min-height:18px; }

  /* BUTTONS */
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:11px 20px; border-radius:8px; font-family:'Lato',sans-serif; font-size:13px; font-weight:700; letter-spacing:1px; cursor:pointer; border:none; transition:all 0.2s; text-transform:uppercase; }
  .btn-gold { background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:#0e0b07; width:100%; margin-top:6px; }
  .btn-gold:hover { background:linear-gradient(135deg,var(--gold),var(--gold-light)); transform:translateY(-1px); box-shadow:0 4px 20px rgba(201,168,76,0.3); }
  .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-muted); }
  .btn-outline:hover { border-color:var(--gold-dark); color:var(--gold); }
  .btn-danger { background:rgba(201,76,76,0.15); border:1px solid rgba(201,76,76,0.3); color:var(--red); }
  .btn-danger:hover { background:rgba(201,76,76,0.25); }
  .btn-success { background:rgba(76,154,106,0.15); border:1px solid rgba(76,154,106,0.3); color:var(--green); }
  .btn-success:hover { background:rgba(76,154,106,0.25); }

  /* APP */
  #app { display:none; flex-direction:column; height:100vh; position:relative; z-index:1; }

  /* HEADER */
  header { background:var(--surface); border-bottom:1px solid var(--border); padding:0 20px; height:60px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:50; flex-shrink:0; }
  .header-brand { display:flex; align-items:center; gap:10px; }
  .header-brand span { font-size:22px; }
  .header-brand h2 { font-family:'Playfair Display',serif; font-size:18px; color:var(--gold-light); }
  .header-actions { display:flex; align-items:center; gap:8px; }
  #admin-badge { background:linear-gradient(135deg,var(--gold-dark),var(--gold)); color:#0e0b07; border-radius:20px; padding:3px 12px; font-size:11px; font-weight:700; letter-spacing:1px; display:none; }
  .icon-btn { width:36px; height:36px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:16px; transition:all 0.2s; }
  .icon-btn:hover { border-color:var(--gold-dark); color:var(--gold); }

  /* VIEW BANNER */
  #view-banner { background:linear-gradient(90deg,rgba(201,168,76,0.07),rgba(201,168,76,0.03)); border-bottom:1px solid rgba(201,168,76,0.13); padding:8px 20px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; font-size:13px; color:var(--text-muted); }
  #view-banner strong { color:var(--gold); }
  #view-banner .vb-btn { background:transparent; border:1px solid var(--gold-dark); border-radius:6px; padding:4px 14px; font-size:12px; color:var(--gold); cursor:pointer; font-family:'Lato',sans-serif; font-weight:700; letter-spacing:1px; transition:all 0.2s; }
  #view-banner .vb-btn:hover { background:rgba(201,168,76,0.1); }

  /* TOOLBARS */
  #admin-toolbar { background:var(--surface); border-bottom:1px solid var(--border); padding:10px 20px; display:none; align-items:center; gap:10px; flex-wrap:wrap; flex-shrink:0; }
  #admin-toolbar .btn { padding:9px 16px; font-size:12px; }
  #viewer-toolbar { background:var(--surface); border-bottom:1px solid var(--border); padding:8px 16px; display:flex; align-items:center; gap:8px; flex-shrink:0; }
  #viewer-toolbar .btn { padding:7px 14px; font-size:12px; }
  .toolbar-sep { width:1px; height:24px; background:var(--border); margin:0 4px; }
  #search-box { flex:1; min-width:140px; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px 14px; color:var(--text); font-size:14px; font-family:'Lato',sans-serif; outline:none; display:none; }
  #search-box:focus { border-color:var(--gold-dark); }
  #search-box::placeholder { color:var(--text-muted); }

  /* CANVAS */
  #canvas-wrap { flex:1; overflow:hidden; position:relative; cursor:grab; }
  #canvas-wrap.grabbing { cursor:grabbing; }
  #canvas { position:absolute; transform-origin:0 0; }
  #svg-layer { position:absolute; top:0; left:0; overflow:visible; pointer-events:none; }

  /* PERSON CARD */
  .person-card { position:absolute; width:160px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:14px 12px 12px; cursor:pointer; transition:border-color 0.2s,box-shadow 0.2s,transform 0.15s; user-select:none; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .person-card:hover { border-color:var(--gold-dark); box-shadow:0 0 24px rgba(201,168,76,0.15); transform:translateY(-2px); }
  .person-card.selected { border-color:var(--gold); box-shadow:0 0 32px rgba(201,168,76,0.25); }
  .person-card.highlighted { border-color:var(--gold-light); box-shadow:0 0 40px rgba(232,201,122,0.4); }
  .person-avatar { width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:700; border:2px solid var(--border); flex-shrink:0; }
  .person-avatar.male   { background:rgba(58,110,168,0.2); border-color:rgba(58,110,168,0.5); color:#7aacdf; }
  .person-avatar.female { background:rgba(168,58,110,0.2); border-color:rgba(168,58,110,0.5); color:#df7aac; }
  .person-avatar.unknown{ background:var(--surface2); border-color:var(--border); color:var(--text-muted); }
  .person-name  { font-family:'Playfair Display',serif; font-size:13px; text-align:center; color:var(--text); line-height:1.3; font-weight:700; word-break:break-word; }
  .person-meta  { font-size:11px; color:var(--text-muted); text-align:center; }
  .person-badge { font-size:10px; background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:2px 7px; color:var(--text-muted); }

  /* PROFILE POPUP (viewers) */
  #profile-popup { position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(130px); background:var(--surface); border:1px solid var(--gold-dark); border-radius:16px; padding:20px 24px; width:92%; max-width:380px; z-index:60; transition:transform 0.3s ease; box-shadow:0 -4px 40px rgba(0,0,0,0.5); display:flex; flex-direction:column; gap:10px; }
  #profile-popup.open { transform:translateX(-50%) translateY(0); }
  .popup-header { display:flex; align-items:center; gap:14px; }
  .popup-name { font-family:'Playfair Display',serif; font-size:17px; color:var(--gold-light); }
  .popup-meta { font-size:12px; color:var(--text-muted); line-height:1.6; margin-top:2px; }
  .popup-close { position:absolute; top:12px; right:14px; background:transparent; border:none; color:var(--text-muted); font-size:18px; cursor:pointer; }
  .popup-chip { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:4px 10px; font-size:11px; color:var(--text-muted); }
  .popup-rels { display:flex; flex-wrap:wrap; gap:6px; }

  /* SIDE PANEL */
  #side-panel { position:fixed; right:0; top:0; bottom:0; width:340px; background:var(--surface); border-left:1px solid var(--border); z-index:60; transform:translateX(100%); transition:transform 0.3s ease; display:flex; flex-direction:column; overflow:hidden; }
  #side-panel.open { transform:translateX(0); }
  .panel-header { padding:18px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .panel-header h3 { font-family:'Playfair Display',serif; font-size:18px; color:var(--gold-light); }
  .panel-body { padding:20px; overflow-y:auto; flex:1; }
  .panel-footer { padding:14px 20px; border-top:1px solid var(--border); display:flex; gap:8px; flex-shrink:0; }
  .panel-footer .btn { flex:1; }
  .field-group { margin-bottom:16px; }
  .field-group label { display:block; font-size:11px; letter-spacing:1.5px; color:var(--text-muted); text-transform:uppercase; margin-bottom:6px; }
  .field-group input,.field-group select,.field-group textarea { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--text); font-size:14px; font-family:'Lato',sans-serif; outline:none; resize:vertical; transition:border-color 0.2s; }
  .field-group input:focus,.field-group select:focus,.field-group textarea:focus { border-color:var(--gold-dark); }
  .field-group select option { background:var(--surface); }
  .section-title { font-size:11px; letter-spacing:2px; text-transform:uppercase; color:var(--gold-dark); margin-bottom:10px; margin-top:20px; border-bottom:1px solid var(--border); padding-bottom:6px; }
  .chip-list { display:flex; flex-wrap:wrap; gap:6px; }
  .chip { background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:5px 12px; font-size:12px; color:var(--text-muted); display:flex; align-items:center; gap:6px; }
  .chip-x { color:var(--red); font-weight:700; font-size:14px; line-height:1; cursor:pointer; }
  .photo-upload-area { border:2px dashed var(--border); border-radius:8px; padding:16px; text-align:center; cursor:pointer; transition:border-color 0.2s; color:var(--text-muted); font-size:13px; }
  .photo-upload-area:hover { border-color:var(--gold-dark); color:var(--gold); }

  /* MODALS */
  .modal-overlay { position:fixed; inset:0; background:rgba(14,11,7,0.85); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px); }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; max-width:400px; width:100%; box-shadow:var(--shadow); }
  .modal h4 { font-family:'Playfair Display',serif; font-size:20px; color:var(--gold-light); margin-bottom:10px; }
  .modal p { color:var(--text-muted); font-size:14px; line-height:1.6; margin-bottom:20px; }
  .modal-actions { display:flex; gap:10px; }
  .modal-actions .btn { flex:1; }
  .rel-options { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px; }
  .rel-btn { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px; cursor:pointer; text-align:center; transition:all 0.2s; color:var(--text); font-family:'Lato',sans-serif; font-size:13px; }
  .rel-btn:hover { border-color:var(--gold-dark); color:var(--gold); background:rgba(201,168,76,0.05); }
  .rel-btn .rel-icon { font-size:22px; display:block; margin-bottom:6px; }

  /* EMPTY STATE */
  #empty-state { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; pointer-events:none; }
  #empty-state .big-tree { font-size:80px; opacity:0.12; }
  #empty-state p { color:var(--text-muted); font-size:15px; text-align:center; max-width:280px; line-height:1.6; }

  /* TOAST */
  #toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 20px; font-size:14px; z-index:999; transition:transform 0.3s ease; white-space:nowrap; box-shadow:var(--shadow); }
  #toast.show { transform:translateX(-50%) translateY(0); }
  #toast.success { border-color:var(--green); color:var(--green); }
  #toast.error   { border-color:var(--red);   color:var(--red); }

  /* ZOOM */
  #zoom-indicator { position:fixed; bottom:20px; right:20px; background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:4px 10px; font-size:12px; color:var(--text-muted); z-index:40; pointer-events:none; }

  /* RESPONSIVE */
  @media (max-width:600px) {
    #side-panel { width:100%; }
    .auth-box { padding:28px 20px; }
    header { padding:0 12px; }
    .btn-text { display:none; }
    #view-banner { font-size:12px; padding:6px 12px; }
  }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <p style="color:var(--text-muted);font-size:14px">Loading family tree‚Ä¶</p>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="admin-login-modal">
  <div class="auth-box">
    <div class="auth-logo">
      <span class="tree-icon">üîê</span>
      <h1>Admin Login</h1>
      <p>FAMILY TREE MANAGEMENT</p>
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="admin@email.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="auth-error" id="login-error"></div>
    <button class="btn btn-gold" onclick="doLogin()">üîê Sign In as Admin</button>
    <button class="btn btn-outline" onclick="closeAdminLogin()" style="width:100%;margin-top:10px;font-size:12px">‚úï Cancel ‚Äî Continue Viewing</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">

  <header>
    <div class="header-brand">
      <span>üå≥</span>
      <h2>Amin Ansari Family Tree</h2>
    </div>
    <div class="header-actions">
      <span id="admin-badge">üëë ADMIN</span>
      <button class="icon-btn" onclick="toggleSearch()" title="Search">üîç</button>
      <button class="icon-btn" onclick="fitView()" title="Fit view">‚äû</button>
      <button id="btn-admin-login"  class="icon-btn" onclick="openAdminLogin()" title="Admin Login" style="font-size:13px;letter-spacing:0">üîê</button>
      <button id="btn-admin-logout" class="icon-btn" onclick="doLogout()" title="Sign out" style="display:none">‚èè</button>
    </div>
  </header>

  <!-- Shown to everyone who is NOT admin -->
  <div id="view-banner">
    <span>üëÅ <strong>View Only</strong> ‚Äî Browsing the Amin Ansari Family Tree</span>
    <button class="vb-btn" onclick="openAdminLogin()">üîê Admin</button>
  </div>

  <!-- Admin-only toolbar -->
  <div id="admin-toolbar">
    <button class="btn btn-gold" onclick="openAddPerson()">Ôºã <span class="btn-text">Add Person</span></button>
    <div class="toolbar-sep"></div>
    <button class="btn btn-outline" onclick="zoomOut()">Ôºç</button>
    <button class="btn btn-outline" onclick="zoomIn()">Ôºã</button>
    <button class="btn btn-outline" onclick="fitView()">‚ä°</button>
    <div class="toolbar-sep"></div>
    <button class="btn btn-outline" onclick="exportData()">‚¨á <span class="btn-text">Export</span></button>
  </div>

  <!-- Viewer toolbar ‚Äî zoom + search for everyone -->
  <div id="viewer-toolbar">
    <button class="btn btn-outline" onclick="zoomOut()">Ôºç</button>
    <button class="btn btn-outline" onclick="zoomIn()">Ôºã</button>
    <button class="btn btn-outline" onclick="fitView()">‚ä°</button>
    <input type="text" id="search-box" placeholder="üîç Search name‚Ä¶" oninput="doSearch(this.value)">
  </div>

  <div id="canvas-wrap">
    <div id="empty-state">
      <div class="big-tree">üå≥</div>
      <p id="empty-msg">Loading‚Ä¶</p>
    </div>
    <div id="canvas">
      <svg id="svg-layer"></svg>
    </div>
  </div>

  <div id="zoom-indicator">100%</div>
</div>

<!-- PROFILE POPUP (for non-admin viewers) -->
<div id="profile-popup">
  <button class="popup-close" onclick="closeProfilePopup()">‚úï</button>
  <div class="popup-header">
    <div id="popup-avatar-wrap"></div>
    <div>
      <div class="popup-name" id="popup-name"></div>
      <div class="popup-meta" id="popup-meta"></div>
    </div>
  </div>
  <div id="popup-notes" style="font-size:13px;color:var(--text-muted);line-height:1.6;display:none"></div>
  <div id="popup-rels-wrap" style="display:none">
    <div style="font-size:11px;letter-spacing:1px;color:var(--gold-dark);text-transform:uppercase;margin-bottom:6px">Relations</div>
    <div class="popup-rels" id="popup-rels"></div>
  </div>
</div>

<!-- ADMIN EDIT PANEL -->
<div id="side-panel">
  <div class="panel-header">
    <h3 id="panel-title">Add Person</h3>
    <button class="icon-btn" onclick="closePanel()">‚úï</button>
  </div>
  <div class="panel-body">
    <input type="hidden" id="edit-id">
    <div class="field-group" style="text-align:center">
      <div id="photo-preview" style="margin-bottom:10px"></div>
      <div class="photo-upload-area" onclick="document.getElementById('photo-file').click()">üì∑ Tap to add photo</div>
      <input type="file" id="photo-file" accept="image/*" style="display:none" onchange="handlePhoto(this)">
      <input type="hidden" id="edit-photo">
    </div>
    <div class="field-group"><label>First Name *</label><input type="text" id="edit-first" placeholder="First name"></div>
    <div class="field-group"><label>Last Name</label><input type="text" id="edit-last" placeholder="Last name"></div>
    <div class="field-group">
      <label>Gender</label>
      <select id="edit-gender">
        <option value="unknown">Prefer not to say</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </div>
    <div class="field-group"><label>Date of Birth</label><input type="date" id="edit-dob"></div>
    <div class="field-group"><label>Date of Death</label><input type="date" id="edit-dod"></div>
    <div class="field-group"><label>Birthplace</label><input type="text" id="edit-place" placeholder="City, Country"></div>
    <div class="field-group"><label>Notes / Bio</label><textarea id="edit-notes" rows="3" placeholder="Brief biography‚Ä¶"></textarea></div>
    <div id="relations-section" style="display:none">
      <div class="section-title">Relations</div>
      <div id="relations-list" class="chip-list"></div>
      <button class="btn btn-outline" style="margin-top:10px;width:100%;font-size:12px" onclick="openRelationPicker()">Ôºã Add Relation</button>
    </div>
  </div>
  <div class="panel-footer">
    <button class="btn btn-success" onclick="savePerson()">üíæ Save</button>
    <button id="btn-delete-person" class="btn btn-danger" onclick="confirmDelete()" style="display:none">üóë</button>
    <button class="btn btn-outline" onclick="closePanel()">Cancel</button>
  </div>
</div>

<!-- RELATION TYPE MODAL -->
<div id="relation-modal" class="modal-overlay" style="display:none">
  <div class="modal">
    <h4>Add Relation</h4>
    <p style="margin-bottom:0">Relationship type for <strong id="rel-person-name" style="color:var(--gold)"></strong>:</p>
    <div class="rel-options">
      <button class="rel-btn" onclick="addRelation('parent')"><span class="rel-icon">üë¥</span>Parent of me</button>
      <button class="rel-btn" onclick="addRelation('child')"><span class="rel-icon">üë∂</span>Child of me</button>
      <button class="rel-btn" onclick="addRelation('spouse')"><span class="rel-icon">üíç</span>Spouse</button>
      <button class="rel-btn" onclick="addRelation('sibling')"><span class="rel-icon">ü§ù</span>Sibling</button>
    </div>
    <div style="margin-top:14px;text-align:right"><button class="btn btn-outline" onclick="closeRelationModal()">Cancel</button></div>
  </div>
</div>

<!-- PERSON SELECT MODAL -->
<div id="person-select-modal" class="modal-overlay" style="display:none">
  <div class="modal" style="max-width:480px">
    <h4>Select Person</h4>
    <input type="text" id="person-filter" placeholder="Type to filter‚Ä¶" oninput="filterPersonList(this.value)"
      style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Lato',sans-serif;font-size:14px;outline:none;margin-bottom:12px">
    <div id="person-list" style="max-height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:6px"></div>
    <div style="margin-top:14px;text-align:right"><button class="btn btn-outline" onclick="closePersonSelect()">Cancel</button></div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div id="confirm-modal" class="modal-overlay" style="display:none">
  <div class="modal">
    <h4>Delete Person?</h4>
    <p>This will permanently remove this person and all their connections. This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="deletePerson()">üóë Delete</button>
      <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üîß FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCuSuydApfXzvWQNXrg7wAjo13SwxxNn9w",
  authDomain: "my-family-tree-41cbe.firebaseapp.com",
  projectId: "my-family-tree-41cbe",
  storageBucket: "my-family-tree-41cbe.firebasestorage.app",
  messagingSenderId: "915926313263",
  appId: "1:915926313263:web:7d55bb49c19e15b2a219da",
  measurementId: "G-49E2BPLGMH"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üëë ADMIN EMAIL ‚Äî Only this person can edit
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_EMAIL = "sajideee2015@gmail.com";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üìñ SHARED TREE ID ‚Äî Everyone reads this tree
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TREE_DOC_ID = "amin_ansari_family";

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db   = firebase.firestore();
const treeRef = db.collection('trees').doc(TREE_DOC_ID);

let currentUser = null;
let isAdmin     = false;
let unsubscribe = null;
let persons     = {};
let relations   = {};
let selectedId  = null;
let panX=80, panY=80, zoom=1, isPanning=false, panStart={x:0,y:0}, lastTouch=null;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
auth.onAuthStateChanged(user => {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display     = 'flex';

  if (user && user.email === ADMIN_EMAIL) {
    currentUser = user; isAdmin = true;
    setAdminUI(true);
    showToast('Welcome, Admin! üëë', 'success');
  } else {
    currentUser = null; isAdmin = false;
    setAdminUI(false);
    if (user) auth.signOut(); // reject non-admin accounts
  }
  if (!unsubscribe) listenToTree();
});

function setAdminUI(admin) {
  document.getElementById('btn-admin-login').style.display  = admin ? 'none' : '';
  document.getElementById('btn-admin-logout').style.display = admin ? ''     : 'none';
  document.getElementById('admin-badge').style.display      = admin ? ''     : 'none';
  document.getElementById('admin-toolbar').style.display    = admin ? 'flex' : 'none';
  document.getElementById('viewer-toolbar').style.display   = admin ? 'none' : 'flex';
  document.getElementById('view-banner').style.display      = admin ? 'none' : '';
  renderTree();
}

function openAdminLogin()  { document.getElementById('admin-login-modal').classList.add('open'); setTimeout(()=>document.getElementById('login-email').focus(),100); }
function closeAdminLogin() { document.getElementById('admin-login-modal').classList.remove('open'); document.getElementById('login-error').textContent=''; }

async function doLogin() {
  const e=document.getElementById('login-email').value.trim();
  const p=document.getElementById('login-pass').value;
  document.getElementById('login-error').textContent='';
  if(e!==ADMIN_EMAIL){ document.getElementById('login-error').textContent='Not an authorized admin.'; return; }
  try { await auth.signInWithEmailAndPassword(e,p); closeAdminLogin(); }
  catch(err){ document.getElementById('login-error').textContent=friendlyError(err.code); }
}

async function doLogout() { await auth.signOut(); isAdmin=false; setAdminUI(false); showToast('Signed out','success'); }

function friendlyError(code){
  return {'auth/user-not-found':'No account found.','auth/wrong-password':'Incorrect password.','auth/invalid-email':'Invalid email.'}[code]||'Login failed.';
}

// ‚îÄ‚îÄ FIRESTORE ‚îÄ‚îÄ
function listenToTree(){
  unsubscribe = treeRef.onSnapshot(doc=>{
    const data = doc.exists ? doc.data() : {persons:{},relations:{}};
    persons   = data.persons   || {};
    relations = data.relations || {};
    renderTree();
  }, err=>console.warn('Firestore:',err.message));
}

async function saveTree(){
  if(!isAdmin){ showToast('Admin access required','error'); return; }
  try { await treeRef.set({persons,relations}); }
  catch(e){ showToast('Save failed: '+e.message,'error'); }
}

function uid(){ return Date.now().toString(36)+Math.random().toString(36).substr(2,5); }

// ‚îÄ‚îÄ CANVAS / VIEWPORT ‚îÄ‚îÄ
const canvasWrap = document.getElementById('canvas-wrap');
const canvas     = document.getElementById('canvas');
const svgLayer   = document.getElementById('svg-layer');

function applyTransform(){ canvas.style.transform=`translate(${panX}px,${panY}px) scale(${zoom})`; document.getElementById('zoom-indicator').textContent=Math.round(zoom*100)+'%'; }
function zoomIn() { zoom=Math.min(zoom*1.2,4);    applyTransform(); }
function zoomOut(){ zoom=Math.max(zoom/1.2,0.15); applyTransform(); }

function fitView(){
  const cards=document.querySelectorAll('.person-card');
  if(!cards.length){panX=80;panY=80;zoom=1;applyTransform();return;}
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  cards.forEach(c=>{ const l=parseInt(c.style.left),t=parseInt(c.style.top); minX=Math.min(minX,l);minY=Math.min(minY,t);maxX=Math.max(maxX,l+160);maxY=Math.max(maxY,t+120); });
  const W=canvasWrap.clientWidth,H=canvasWrap.clientHeight,tw=maxX-minX+80,th=maxY-minY+80;
  zoom=Math.min(W/tw,H/th,1.5);
  panX=(W-tw*zoom)/2-minX*zoom+40*zoom;
  panY=(H-th*zoom)/2-minY*zoom+40*zoom;
  applyTransform();
}

// Mouse pan
canvasWrap.addEventListener('mousedown',e=>{ if(e.target===canvasWrap||e.target===canvas||e.target===svgLayer){isPanning=true;panStart={x:e.clientX-panX,y:e.clientY-panY};canvasWrap.classList.add('grabbing');} });
document.addEventListener('mousemove',e=>{ if(isPanning){panX=e.clientX-panStart.x;panY=e.clientY-panStart.y;applyTransform();} });
document.addEventListener('mouseup',()=>{ isPanning=false;canvasWrap.classList.remove('grabbing'); });
// Wheel zoom
canvasWrap.addEventListener('wheel',e=>{ e.preventDefault();const d=e.deltaY>0?0.9:1.1,rect=canvasWrap.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top,nz=Math.max(0.15,Math.min(4,zoom*d));panX=mx-(mx-panX)*(nz/zoom);panY=my-(my-panY)*(nz/zoom);zoom=nz;applyTransform(); },{passive:false});
// Touch pan/pinch
canvasWrap.addEventListener('touchstart',e=>{ if(e.touches.length===1){isPanning=true;lastTouch=e.touches[0];panStart={x:e.touches[0].clientX-panX,y:e.touches[0].clientY-panY};}if(e.touches.length===2){isPanning=false;lastTouch=e.touches;} },{passive:true});
canvasWrap.addEventListener('touchmove',e=>{ if(e.touches.length===1&&isPanning){panX=e.touches[0].clientX-panStart.x;panY=e.touches[0].clientY-panStart.y;applyTransform();}if(e.touches.length===2&&lastTouch&&lastTouch.length===2){const d1=Math.hypot(lastTouch[0].clientX-lastTouch[1].clientX,lastTouch[0].clientY-lastTouch[1].clientY),d2=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),mid={x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2},rect=canvasWrap.getBoundingClientRect(),mx=mid.x-rect.left,my=mid.y-rect.top,nz=Math.max(0.15,Math.min(4,zoom*(d2/d1)));panX=mx-(mx-panX)*(nz/zoom);panY=my-(my-panY)*(nz/zoom);zoom=nz;applyTransform();lastTouch=e.touches;} },{passive:true});
canvasWrap.addEventListener('touchend',()=>{ isPanning=false;lastTouch=null; });

// Close popups when clicking empty canvas
canvasWrap.addEventListener('click',e=>{ if(e.target===canvasWrap||e.target===canvas||e.target===svgLayer){selectedId=null;document.querySelectorAll('.person-card').forEach(c=>c.classList.remove('selected'));closePanel();closeProfilePopup();} });

// ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ
function computeLayout(){
  const ids=Object.keys(persons),pos={};
  if(!ids.length)return pos;
  function getParents(id){return Object.values(relations).filter(r=>r.type==='parent-child'&&r.child===id).map(r=>r.parent);}
  function getChildren(id){return Object.values(relations).filter(r=>r.type==='parent-child'&&r.parent===id).map(r=>r.child);}
  function getSpouses(id){return Object.values(relations).filter(r=>r.type==='spouse'&&(r.from===id||r.to===id)).map(r=>r.from===id?r.to:r.from);}
  const genMap={};
  function assignGen(id,gen){if(genMap[id]!==undefined)return;genMap[id]=gen;getChildren(id).forEach(c=>assignGen(c,gen+1));getSpouses(id).forEach(s=>{if(genMap[s]===undefined)genMap[s]=gen;});}
  ids.filter(id=>getParents(id).length===0).forEach(r=>assignGen(r,0));
  ids.forEach(id=>{if(genMap[id]===undefined)genMap[id]=0;});
  const gens={};
  ids.forEach(id=>{const g=genMap[id];(gens[g]=gens[g]||[]).push(id);});
  Object.keys(gens).sort((a,b)=>+a-+b).forEach(g=>{gens[g].forEach((id,i)=>{pos[id]={x:i*220,y:+g*200};});});
  ids.forEach(id=>{if(persons[id].x!==undefined&&persons[id].y!==undefined)pos[id]={x:persons[id].x,y:persons[id].y};});
  return pos;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderTree(){
  const ids=Object.keys(persons);
  document.getElementById('empty-state').style.display=ids.length?'none':'flex';
  if(!ids.length){document.getElementById('empty-msg').textContent=isAdmin?'Tap "+ Add Person" to begin.':'This family tree is empty.';}
  document.querySelectorAll('.person-card').forEach(c=>c.remove());
  svgLayer.innerHTML='';
  if(!ids.length)return;
  const pos=computeLayout();
  const maxX=Math.max(...Object.values(pos).map(p=>p.x))+200,maxY=Math.max(...Object.values(pos).map(p=>p.y))+200;
  svgLayer.setAttribute('width',maxX+200);svgLayer.setAttribute('height',maxY+200);
  svgLayer.style.width=(maxX+200)+'px';svgLayer.style.height=(maxY+200)+'px';
  Object.values(relations).forEach(rel=>{const fp=pos[rel.from||rel.parent],tp=pos[rel.to||rel.child];if(fp&&tp)drawConnection(rel,fp,tp);});
  ids.forEach(id=>createCard(id,persons[id],pos[id]?.x||80,pos[id]?.y||80));
  if(selectedId&&persons[selectedId])updateRelationsList(selectedId);
}

function createCard(id,p,x,y){
  const card=document.createElement('div');
  card.className='person-card'+(id===selectedId?' selected':'');
  card.id='card-'+id; card.style.left=x+'px'; card.style.top=y+'px';
  const initials=((p.firstName||'?')[0]+(p.lastName||'')[0]).toUpperCase();
  const gc=p.gender||'unknown';
  const avatar=p.photo?`<img src="${p.photo}" class="person-avatar" style="object-fit:cover;border:2px solid var(--gold-dark)" alt="">`:`<div class="person-avatar ${gc}">${initials}</div>`;
  const dob=p.dob?new Date(p.dob).getFullYear():'',dod=p.dod?new Date(p.dod).getFullYear():'';
  const ls=dob?(dod?`${dob} ‚Äì ${dod}`:`b. ${dob}`):'';
  card.innerHTML=`${avatar}<div class="person-name">${p.firstName||''} ${p.lastName||''}</div>${ls?`<div class="person-meta">${ls}</div>`:''} ${p.place?`<div class="person-badge">üìç ${p.place}</div>`:''}`;
  card.addEventListener('click',e=>{ e.stopPropagation(); onCardClick(id); });
  if(isAdmin) makeDraggable(card,id);
  canvas.appendChild(card);
}

function onCardClick(id){
  selectedId=id;
  document.querySelectorAll('.person-card').forEach(c=>c.classList.toggle('selected',c.id==='card-'+id));
  if(isAdmin){ closeProfilePopup(); openEditPerson(id); }
  else       { closePanel(); openProfilePopup(id); }
}

function makeDraggable(card,id){
  let drag=false,ox=0,oy=0,moved=false;
  const start=(cx,cy)=>{ drag=true;moved=false;ox=(cx-panX)/zoom-parseInt(card.style.left);oy=(cy-panY)/zoom-parseInt(card.style.top); };
  const move=(cx,cy)=>{ if(!drag)return;moved=true;card.style.left=Math.max(0,(cx-panX)/zoom-ox)+'px';card.style.top=Math.max(0,(cy-panY)/zoom-oy)+'px';redrawConnections(); };
  const end=()=>{ if(!drag)return;drag=false;if(moved){persons[id].x=parseInt(card.style.left);persons[id].y=parseInt(card.style.top);saveTree();} };
  card.addEventListener('mousedown',e=>{ if(e.button===0){e.stopPropagation();start(e.clientX,e.clientY);} });
  document.addEventListener('mousemove',e=>{ if(drag)move(e.clientX,e.clientY); });
  document.addEventListener('mouseup',end);
  card.addEventListener('touchstart',e=>{ e.stopPropagation();start(e.touches[0].clientX,e.touches[0].clientY); },{passive:true});
  card.addEventListener('touchmove',e=>{ move(e.touches[0].clientX,e.touches[0].clientY); },{passive:true});
  card.addEventListener('touchend',end);
}

function drawConnection(rel,fp,tp){
  const x1=fp.x+80,y1=fp.y+70,x2=tp.x+80,y2=tp.y+70;
  let color='#3a3020',dashed=false;
  if(rel.type==='parent-child')color='#4c6e4a';
  else if(rel.type==='spouse'){color='#8a5a4a';dashed=true;}
  else if(rel.type==='sibling')color='#4a5a8a';
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d',`M${x1},${y1} C${x1},${y1+(y2-y1)*0.4} ${x2},${y2-(y2-y1)*0.4} ${x2},${y2}`);
  p.setAttribute('stroke',color);p.setAttribute('stroke-width','2');p.setAttribute('fill','none');p.setAttribute('opacity','0.7');
  if(dashed)p.setAttribute('stroke-dasharray','6,4');
  svgLayer.appendChild(p);
  const t=document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',(x1+x2)/2);t.setAttribute('y',(y1+y2)/2-6);t.setAttribute('text-anchor','middle');t.setAttribute('font-size','12');t.setAttribute('fill','#6a5d48');
  t.textContent={'parent-child':'üë∂','spouse':'üíç','sibling':'ü§ù'}[rel.type]||'';
  svgLayer.appendChild(t);
}

function redrawConnections(){
  svgLayer.innerHTML='';
  const pos={};
  document.querySelectorAll('.person-card').forEach(c=>{const id=c.id.replace('card-','');pos[id]={x:parseInt(c.style.left),y:parseInt(c.style.top)};});
  Object.values(relations).forEach(rel=>{const fp=pos[rel.from||rel.parent],tp=pos[rel.to||rel.child];if(fp&&tp)drawConnection(rel,fp,tp);});
}

// ‚îÄ‚îÄ PROFILE POPUP (view mode) ‚îÄ‚îÄ
function openProfilePopup(id){
  const p=persons[id];if(!p)return;
  const initials=((p.firstName||'?')[0]+(p.lastName||'')[0]).toUpperCase();
  const gc=p.gender||'unknown';
  document.getElementById('popup-avatar-wrap').innerHTML=p.photo
    ?`<img src="${p.photo}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid var(--gold-dark)" alt="">`
    :`<div class="person-avatar ${gc}" style="width:56px;height:56px">${initials}</div>`;
  document.getElementById('popup-name').textContent=`${p.firstName||''} ${p.lastName||''}`.trim();
  const dob=p.dob?new Date(p.dob).getFullYear():'',dod=p.dod?new Date(p.dod).getFullYear():'';
  const ls=dob?(dod?`${dob} ‚Äì ${dod}`:`b. ${dob}`):'';
  document.getElementById('popup-meta').textContent=[ls,p.place?'üìç '+p.place:''].filter(Boolean).join('  ‚Ä¢  ');
  const notesEl=document.getElementById('popup-notes');
  if(p.notes){notesEl.textContent=p.notes;notesEl.style.display='';}else{notesEl.style.display='none';}
  const myRels=Object.entries(relations).filter(([k,r])=>r.from===id||r.to===id||r.parent===id||r.child===id);
  const relsDiv=document.getElementById('popup-rels');relsDiv.innerHTML='';
  if(myRels.length){
    myRels.forEach(([k,r])=>{
      const oid=(r.from===id?r.to:r.to===id?r.from:r.parent===id?r.child:r.parent);
      const o=persons[oid];if(!o)return;
      const lbl={'parent-child':r.parent===id?'Parent of':'Child of','spouse':'Spouse of','sibling':'Sibling of'}[r.type]||r.type;
      const c=document.createElement('div');c.className='popup-chip';c.textContent=`${lbl} ${o.firstName} ${o.lastName||''}`;relsDiv.appendChild(c);
    });
    document.getElementById('popup-rels-wrap').style.display='';
  } else { document.getElementById('popup-rels-wrap').style.display='none'; }
  document.getElementById('profile-popup').classList.add('open');
}
function closeProfilePopup(){ document.getElementById('profile-popup').classList.remove('open'); }

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ
function openAddPerson(){
  if(!isAdmin)return;
  clearPanel();
  document.getElementById('panel-title').textContent='Add Person';
  document.getElementById('btn-delete-person').style.display='none';
  document.getElementById('relations-section').style.display='none';
  document.getElementById('side-panel').classList.add('open');
}
function openEditPerson(id){
  if(!isAdmin)return;
  const p=persons[id];if(!p)return;
  document.getElementById('panel-title').textContent='Edit Person';
  document.getElementById('btn-delete-person').style.display='';
  document.getElementById('edit-id').value=id;
  document.getElementById('edit-first').value=p.firstName||'';
  document.getElementById('edit-last').value=p.lastName||'';
  document.getElementById('edit-gender').value=p.gender||'unknown';
  document.getElementById('edit-dob').value=p.dob||'';
  document.getElementById('edit-dod').value=p.dod||'';
  document.getElementById('edit-place').value=p.place||'';
  document.getElementById('edit-notes').value=p.notes||'';
  document.getElementById('edit-photo').value=p.photo||'';
  updatePhotoPreview(p.photo);
  document.getElementById('relations-section').style.display='';
  updateRelationsList(id);
  document.getElementById('side-panel').classList.add('open');
}
function clearPanel(){ ['edit-id','edit-first','edit-last','edit-dob','edit-dod','edit-place','edit-notes','edit-photo'].forEach(f=>document.getElementById(f).value=''); document.getElementById('edit-gender').value='unknown'; document.getElementById('photo-preview').innerHTML=''; }
function closePanel(){ document.getElementById('side-panel').classList.remove('open'); }

async function savePerson(){
  if(!isAdmin){showToast('Admin access required','error');return;}
  const first=document.getElementById('edit-first').value.trim();
  if(!first){showToast('First name is required','error');return;}
  const id=document.getElementById('edit-id').value||uid();
  const ex=persons[id]||{};
  persons[id]={firstName:first,lastName:document.getElementById('edit-last').value.trim(),gender:document.getElementById('edit-gender').value,dob:document.getElementById('edit-dob').value,dod:document.getElementById('edit-dod').value,place:document.getElementById('edit-place').value.trim(),notes:document.getElementById('edit-notes').value.trim(),photo:document.getElementById('edit-photo').value,x:ex.x,y:ex.y,createdAt:ex.createdAt||Date.now(),updatedAt:Date.now()};
  await saveTree();
  showToast('Saved! ‚úì','success');
  selectedId=id;
  document.getElementById('edit-id').value=id;
  document.getElementById('panel-title').textContent='Edit Person';
  document.getElementById('btn-delete-person').style.display='';
  document.getElementById('relations-section').style.display='';
  updateRelationsList(id);
}

function confirmDelete(){ if(isAdmin)document.getElementById('confirm-modal').style.display='flex'; }
function closeConfirm(){ document.getElementById('confirm-modal').style.display='none'; }
async function deletePerson(){
  if(!isAdmin)return;
  const id=document.getElementById('edit-id').value;if(!id||!persons[id])return;
  delete persons[id];
  Object.keys(relations).forEach(k=>{const r=relations[k];if(r.from===id||r.to===id||r.parent===id||r.child===id)delete relations[k];});
  await saveTree();closeConfirm();closePanel();selectedId=null;showToast('Deleted','success');
}

// ‚îÄ‚îÄ RELATIONS ‚îÄ‚îÄ
function updateRelationsList(pid){
  const list=document.getElementById('relations-list');list.innerHTML='';
  const myRels=Object.entries(relations).filter(([k,r])=>r.from===pid||r.to===pid||r.parent===pid||r.child===pid);
  if(!myRels.length){list.innerHTML='<span style="color:var(--text-muted);font-size:13px">No relations yet.</span>';return;}
  myRels.forEach(([k,r])=>{
    const oid=(r.from===pid?r.to:r.to===pid?r.from:r.parent===pid?r.child:r.parent);
    const o=persons[oid];if(!o)return;
    const chip=document.createElement('div');chip.className='chip';
    const lbl={'parent-child':r.parent===pid?'Parent of':'Child of','spouse':'Spouse','sibling':'Sibling'}[r.type]||r.type;
    chip.innerHTML=`<span>${lbl} <strong>${o.firstName} ${o.lastName||''}</strong></span><span class="chip-x" onclick="removeRelation('${k}')">√ó</span>`;
    list.appendChild(chip);
  });
}
let pendingRelType=null;
function openRelationPicker(){ const myId=document.getElementById('edit-id').value;if(!myId){showToast('Save person first','error');return;}document.getElementById('rel-person-name').textContent=persons[myId]?.firstName||'';document.getElementById('relation-modal').style.display='flex'; }
function closeRelationModal(){ document.getElementById('relation-modal').style.display='none'; }
function addRelation(type){ pendingRelType=type;closeRelationModal();document.getElementById('person-select-modal').style.display='flex';renderPersonList(document.getElementById('edit-id').value,''); }
function closePersonSelect(){ document.getElementById('person-select-modal').style.display='none'; }
function filterPersonList(q){ renderPersonList(document.getElementById('edit-id').value,q); }
function renderPersonList(myId,q){
  const c=document.getElementById('person-list');c.innerHTML='';
  Object.entries(persons).filter(([id,p])=>id!==myId&&(!q||`${p.firstName} ${p.lastName||''}`.toLowerCase().includes(q.toLowerCase()))).forEach(([id,p])=>{
    const row=document.createElement('div');
    row.style.cssText='background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:border-color 0.2s';
    const in2=((p.firstName||'?')[0]+(p.lastName||'')[0]).toUpperCase();
    row.innerHTML=`<div class="person-avatar ${p.gender||'unknown'}" style="width:36px;height:36px;font-size:13px">${in2}</div><span>${p.firstName} ${p.lastName||''}</span>`;
    row.addEventListener('mouseenter',()=>row.style.borderColor='var(--gold-dark)');
    row.addEventListener('mouseleave',()=>row.style.borderColor='var(--border)');
    row.addEventListener('click',()=>finishAddRelation(id));
    c.appendChild(row);
  });
  if(!c.children.length)c.innerHTML='<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px">No persons found.</p>';
}
async function finishAddRelation(targetId){
  closePersonSelect();
  const myId=document.getElementById('edit-id').value,type=pendingRelType;
  let relObj={};const k=uid();
  if(type==='parent') relObj={type:'parent-child',parent:targetId,child:myId,from:targetId,to:myId};
  if(type==='child')  relObj={type:'parent-child',parent:myId,child:targetId,from:myId,to:targetId};
  if(type==='spouse') relObj={type:'spouse',from:myId,to:targetId};
  if(type==='sibling')relObj={type:'sibling',from:myId,to:targetId};
  const dup=Object.values(relations).some(r=>r.type===relObj.type&&((r.from===relObj.from&&r.to===relObj.to)||(r.from===relObj.to&&r.to===relObj.from)||(r.parent===relObj.parent&&r.child===relObj.child)));
  if(dup){showToast('Already exists','error');return;}
  relations[k]=relObj;await saveTree();updateRelationsList(myId);showToast('Relation added!','success');
}
async function removeRelation(k){ if(!relations[k])return;delete relations[k];await saveTree();updateRelationsList(document.getElementById('edit-id').value);showToast('Removed','success'); }

// ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ
function handlePhoto(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{ const cv=document.createElement('canvas'),max=200;let w=img.width,h=img.height;if(w>h){if(w>max){h*=max/w;w=max;}}else{if(h>max){w*=max/h;h=max;}}cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);const d=cv.toDataURL('image/jpeg',0.75);document.getElementById('edit-photo').value=d;updatePhotoPreview(d); };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
function updatePhotoPreview(url){ document.getElementById('photo-preview').innerHTML=url?`<img src="${url}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--gold-dark)">`:''; }

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
let searchVisible=false;
function toggleSearch(){ const b=document.getElementById('search-box');searchVisible=!searchVisible;b.style.display=searchVisible?'':'none';if(searchVisible)b.focus();else{b.value='';doSearch('');} }
function doSearch(q){ document.querySelectorAll('.person-card').forEach(card=>{ const id=card.id.replace('card-',''),p=persons[id];if(!p)return;const name=`${p.firstName} ${p.lastName||''} ${p.place||''}`.toLowerCase(),match=!q||name.includes(q.toLowerCase());card.classList.toggle('highlighted',!!q&&match);card.style.opacity=q&&!match?'0.3':'1'; }); }

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportData(){ const d=JSON.stringify({persons,relations,exportedAt:new Date().toISOString()},null,2),b=new Blob([d],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='amin-ansari-family-tree.json';a.click();URL.revokeObjectURL(u);showToast('Exported!','success'); }

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg,type='success'){ const t=document.getElementById('toast');t.textContent=msg;t.className=type;void t.offsetWidth;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800); }

applyTransform();
</script>
</body>
</html>